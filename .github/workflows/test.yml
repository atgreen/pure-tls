name: Tests

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            name: Linux
          - os: macos-latest
            name: macOS
          - os: windows-latest
            name: Windows

    runs-on: ${{ matrix.os }}
    name: ${{ matrix.name }} (SBCL)

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install SBCL and ocicl (Linux)
        if: runner.os == 'Linux'
        run: |
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          echo "eval \"\$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)\"" >> ~/.bashrc
          brew install sbcl ocicl

      - name: Install SBCL and ocicl (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install sbcl ocicl

      - name: Install SBCL and ocicl (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          choco install -y sbcl
          # Pin to v2.14.1 due to regression in later versions
          Invoke-WebRequest -Uri "https://github.com/ocicl/ocicl/releases/download/v2.14.1/ocicl-2.14.1-windows-amd64.zip" -OutFile "$env:TEMP\ocicl.zip"
          Expand-Archive -Path "$env:TEMP\ocicl.zip" -DestinationPath "$env:TEMP\ocicl"
          Copy-Item "$env:TEMP\ocicl\ocicl.exe" -Destination "C:\Windows\System32\"

      - name: Setup ocicl and fetch dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          ocicl setup > ~/.sbclrc
          ocicl install

      - name: Setup ocicl and fetch dependencies (macOS/Windows)
        if: runner.os != 'Linux'
        run: |
          ocicl setup > ~/.sbclrc
          ocicl install

      - name: Setup ASDF
        run: |
          mkdir -p ~/.config/common-lisp/source-registry.conf.d/
          echo '(:tree "'"$PWD"'")' > ~/.config/common-lisp/source-registry.conf.d/pure-tls.conf

      - name: Build system (Linux)
        if: runner.os == 'Linux'
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          sbcl --non-interactive \
            --eval '(asdf:load-system :pure-tls/test)'

      - name: Build system (macOS/Windows)
        if: runner.os != 'Linux'
        run: |
          sbcl --non-interactive \
            --eval '(asdf:load-system :pure-tls/test)'

      - name: Run offline tests (Linux)
        if: runner.os == 'Linux'
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          sbcl --non-interactive \
            --eval '(asdf:load-system :pure-tls/test)' \
            --eval '(unless (pure-tls/test:run-tests) (uiop:quit 1))'

      - name: Run offline tests (macOS/Windows)
        if: runner.os != 'Linux'
        run: |
          sbcl --non-interactive \
            --eval '(asdf:load-system :pure-tls/test)' \
            --eval '(unless (pure-tls/test:run-tests) (uiop:quit 1))'

      - name: Run network tests (Linux)
        if: runner.os == 'Linux'
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          sbcl --non-interactive \
            --eval '(asdf:load-system :pure-tls/test)' \
            --eval '(format t "~%Platform: ~A~%" (lisp-implementation-type))' \
            --eval '(format t "Windows cert store: ~A~%" pure-tls:*use-windows-certificate-store*)' \
            --eval '(unless (pure-tls/test:run-network-tests) (uiop:quit 1))'

      - name: Run network tests (macOS/Windows)
        if: runner.os != 'Linux'
        run: |
          sbcl --non-interactive \
            --eval '(asdf:load-system :pure-tls/test)' \
            --eval '(format t "~%Platform: ~A~%" (lisp-implementation-type))' \
            --eval '(format t "Windows cert store: ~A~%" pure-tls:*use-windows-certificate-store*)' \
            --eval '(unless (pure-tls/test:run-network-tests) (uiop:quit 1))'

  # BoringSSL regression tests (Linux only)
  boringssl:
    runs-on: ubuntu-latest
    name: BoringSSL Regression Tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install SBCL and ocicl
        run: |
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          echo "eval \"\$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)\"" >> ~/.bashrc
          brew install sbcl ocicl

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Clone BoringSSL
        run: |
          git clone --depth 1 https://boringssl.googlesource.com/boringssl ~/boringssl

      - name: Setup ocicl and fetch dependencies
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          ocicl setup > ~/.sbclrc
          ocicl install

      - name: Setup ASDF
        run: |
          mkdir -p ~/.config/common-lisp/source-registry.conf.d/
          echo '(:tree "'"$PWD"'")' > ~/.config/common-lisp/source-registry.conf.d/pure-tls.conf

      - name: Build BoringSSL test shim
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          make boringssl-shim

      - name: Check for regressions
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          BORINGSSL_DIR=~/boringssl ./test/track-regressions.sh --compare
